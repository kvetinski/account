apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: account
data:
  prometheus.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        uid: prometheus
        type: prometheus
        access: proxy
        url: http://prometheus.account.svc.cluster.local:9090
        isDefault: true
        editable: true
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-provider
  namespace: account
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
      - name: Account Service Dashboards
        orgId: 1
        folder: Account
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-account
  namespace: account
data:
  account-observability.json: |
    {
      "id": null,
      "uid": "account-observability",
      "title": "Account Service Observability",
      "schemaVersion": 39,
      "version": 1,
      "refresh": "10s",
      "time": {"from": "now-30m", "to": "now"},
      "panels": [
        {
          "type": "timeseries",
          "title": "gRPC RPS By Method",
          "id": 1,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [{"expr": "sum(rate(account_grpc_requests_total[$__rate_interval])) by (method)", "legendFormat": "{{method}}", "refId": "A"}]
        },
        {
          "type": "timeseries",
          "title": "DB QPS By Method",
          "id": 2,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [{"expr": "sum(rate(account_db_queries_total[$__rate_interval])) by (method)", "legendFormat": "{{method}}", "refId": "A"}]
        },
        {
          "type": "timeseries",
          "title": "Go Goroutines By Pod",
          "id": 3,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [{"expr": "max by (pod) (go_goroutines{job=\"account-app\"})", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "type": "timeseries",
          "title": "App Memory RSS (MiB) By Pod",
          "id": 4,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [{"expr": "max by (pod) (process_resident_memory_bytes{job=\"account-app\"}) / 1024 / 1024", "legendFormat": "{{pod}}", "refId": "A"}]
        },
        {
          "type": "timeseries",
          "title": "Container CPU (all pods in namespace)",
          "id": 5,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 16},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "sum(rate(container_cpu_usage_seconds_total{container_label_io_kubernetes_pod_namespace=\"account\",container_label_io_kubernetes_pod_name!=\"\"}[$__rate_interval])) by (container_label_io_kubernetes_pod_name)",
              "legendFormat": "{{container_label_io_kubernetes_pod_name}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Container Memory Working Set (MiB, all pods in namespace)",
          "id": 6,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 16},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "sum(container_memory_working_set_bytes{container_label_io_kubernetes_pod_namespace=\"account\",container_label_io_kubernetes_pod_name!=\"\"}) by (container_label_io_kubernetes_pod_name) / 1024 / 1024",
              "legendFormat": "{{container_label_io_kubernetes_pod_name}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "gRPC p95 Latency By Method",
          "id": 7,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 24},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(account_grpc_request_duration_seconds_bucket[$__rate_interval])) by (le, method))",
              "legendFormat": "{{method}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB p95 Latency By Method",
          "id": 8,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 24},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "histogram_quantile(0.95, sum(rate(account_db_query_duration_seconds_bucket[$__rate_interval])) by (le, method))",
              "legendFormat": "{{method}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "gRPC Error Ratio By Method (%)",
          "id": 9,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "100 * sum(rate(account_grpc_requests_total{code!=\"OK\"}[$__rate_interval])) by (method) / clamp_min(sum(rate(account_grpc_requests_total[$__rate_interval])) by (method), 1e-9)",
              "legendFormat": "{{method}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB Error Ratio By Method (%)",
          "id": 10,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "100 * sum(rate(account_db_queries_total{status=\"error\"}[$__rate_interval])) by (method) / clamp_min(sum(rate(account_db_queries_total[$__rate_interval])) by (method), 1e-9)",
              "legendFormat": "{{method}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Go GC p95 Pause (ms) By Pod",
          "id": 11,
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 40},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (go_gc_duration_seconds{job=\"account-app\",quantile=\"0.95\"}) * 1000",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Go Heap In Use (MiB) By Pod",
          "id": 12,
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 40},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (go_memstats_heap_inuse_bytes{job=\"account-app\"}) / 1024 / 1024",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Go Heap Idle (MiB) By Pod",
          "id": 13,
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 40},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (go_memstats_heap_idle_bytes{job=\"account-app\"}) / 1024 / 1024",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Go Next GC Target (MiB) By Pod",
          "id": 14,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 48},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (go_memstats_next_gc_bytes{job=\"account-app\"}) / 1024 / 1024",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Go Allocation Rate (MiB/s) By Pod",
          "id": 15,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 48},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "sum by (pod) (rate(go_memstats_alloc_bytes_total{job=\"account-app\"}[$__rate_interval])) / 1024 / 1024",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Open FDs By Pod",
          "id": 16,
          "gridPos": {"h": 8, "w": 8, "x": 0, "y": 56},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (process_open_fds{job=\"account-app\"})",
              "legendFormat": "{{pod}} open_fds",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Max FDs By Pod",
          "id": 17,
          "gridPos": {"h": 8, "w": 8, "x": 8, "y": 56},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (process_max_fds{job=\"account-app\"})",
              "legendFormat": "{{pod}} max_fds",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Open FD Ratio (%) By Pod",
          "id": 18,
          "gridPos": {"h": 8, "w": 8, "x": 16, "y": 56},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "100 * max by (pod) (process_open_fds{job=\"account-app\"}) / clamp_min(max by (pod) (process_max_fds{job=\"account-app\"}), 1)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Process Start Time (unix) By Pod",
          "id": 19,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 64},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (process_start_time_seconds{job=\"account-app\"})",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "Virtual Memory (MiB) By Pod",
          "id": 20,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 64},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (process_virtual_memory_bytes{job=\"account-app\"}) / 1024 / 1024",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB Pool Connections By Pod",
          "id": 21,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 72},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "max by (pod) (account_db_pool_open_connections{job=\"account-app\"})",
              "legendFormat": "{{pod}} open",
              "refId": "A"
            },
            {
              "expr": "max by (pod) (account_db_pool_in_use_connections{job=\"account-app\"})",
              "legendFormat": "{{pod}} in_use",
              "refId": "B"
            },
            {
              "expr": "max by (pod) (account_db_pool_idle_connections{job=\"account-app\"})",
              "legendFormat": "{{pod}} idle",
              "refId": "C"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB Pool Wait Count/s By Pod",
          "id": 22,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 72},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "rate(account_db_pool_wait_count_total{job=\"account-app\"}[$__rate_interval])",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB Pool Avg Wait Duration (ms) By Pod",
          "id": 23,
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 80},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "1000 * rate(account_db_pool_wait_duration_seconds_total{job=\"account-app\"}[$__rate_interval]) / clamp_min(rate(account_db_pool_wait_count_total{job=\"account-app\"}[$__rate_interval]), 1e-9)",
              "legendFormat": "{{pod}}",
              "refId": "A"
            }
          ]
        },
        {
          "type": "timeseries",
          "title": "DB Pool Closed Connections/s By Pod",
          "id": 24,
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 80},
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "targets": [
            {
              "expr": "rate(account_db_pool_max_idle_closed_total{job=\"account-app\"}[$__rate_interval])",
              "legendFormat": "{{pod}} max_idle_closed",
              "refId": "A"
            },
            {
              "expr": "rate(account_db_pool_max_lifetime_closed_total{job=\"account-app\"}[$__rate_interval])",
              "legendFormat": "{{pod}} max_lifetime_closed",
              "refId": "B"
            }
          ]
        }
      ]
    }
